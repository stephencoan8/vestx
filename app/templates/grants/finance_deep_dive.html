{% extends "base.html" %}

{% block title %}Finance Deep Dive - VestX{% endblock %}

{% block content %}
<div class="finance-deep-dive">
    <header class="page-header">
        <h1>üí∞ Finance Deep Dive</h1>
        <p class="subtitle">Comprehensive tax and capital gains analysis</p>
    </header>

    <!-- Tax Rate Configuration -->
    <div class="tax-config-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;">‚öôÔ∏è Tax Rate Configuration</h2>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <a href="{{ url_for('settings.tax_settings') }}" class="btn btn-secondary" style="text-decoration: none;">
                    Configure Tax Settings
                </a>
                <div class="toggle-container">
                    <label class="toggle-switch">
                        <input type="checkbox" id="showAllToggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <label for="showAllToggle" style="margin-left: 0.5rem; cursor: pointer;">
                        Show <strong><span id="toggleLabel">Vested Only</span></strong>
                    </label>
                </div>
            </div>
        </div>
        {% if use_manual_rates %}
        <p class="text-muted">Adjust these sliders to calculate estimated tax impact if you sold all shares today</p>
        {% else %}
        <p class="text-muted">
            <strong>üí° Tax rates auto-calculated from your profile.</strong> 
            Adjust sliders below to see different scenarios, or 
            <a href="{{ url_for('settings.tax_settings') }}">update your tax profile</a>.
        </p>
        {% endif %}
        
        <div class="tax-sliders">
            <div class="tax-slider-item">
                <label for="federalTaxRate">
                    Federal Tax Rate: <strong><span id="federalTaxValue">{{ "%.1f"|format(tax_rates.federal * 100) }}</span>%</strong>
                </label>
                <input type="range" id="federalTaxRate" min="0" max="37" step="1" value="{{ tax_rates.federal * 100 }}" class="tax-slider">
                <small class="slider-help">Federal income tax bracket (0-37%)</small>
            </div>
            
            <div class="tax-slider-item">
                <label for="stateTaxRate">
                    State Tax Rate: <strong><span id="stateTaxValue">{{ "%.1f"|format(tax_rates.state * 100) }}</span>%</strong>
                </label>
                <input type="range" id="stateTaxRate" min="0" max="13.3" step="0.1" value="{{ tax_rates.state * 100 }}" class="tax-slider">
                <small class="slider-help">State income tax (CA: 0-13.3%)</small>
            </div>
            
            <div class="tax-slider-item">
                <label for="capitalGainsTaxRate">
                    Long-Term Capital Gains: <strong><span id="capitalGainsValue">{{ "%.1f"|format(tax_rates.ltcg * 100) }}</span>%</strong>
                </label>
                <input type="range" id="capitalGainsTaxRate" min="0" max="20" step="1" value="{{ tax_rates.ltcg * 100 }}" class="tax-slider">
                <small class="slider-help">Federal long-term cap gains (0, 15, or 20%)</small>
            </div>
            
            <div class="tax-slider-item">
                <label for="ficaTaxRate">
                    FICA (Social Security + Medicare): <strong><span id="ficaValue">7.65</span>%</strong>
                </label>
                <input type="range" id="ficaTaxRate" min="0" max="7.65" step="0.01" value="7.65" class="tax-slider">
                <small class="slider-help">Payroll taxes (set to 0 if above Social Security wage cap or exempt)</small>
            </div>
        </div>
    </div>

    <!-- Summary Cards with Dynamic Tax Calculations -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <div class="stat-label">Total Shares Held</div>
                <div class="stat-value data-vested">{{ "{:,.0f}".format(total_shares_held_vested) }}</div>
                <div class="stat-value data-all" style="display: none;">{{ "{:,.0f}".format(total_shares_held_all) }}</div>
                <small>@ ${{ "{:,.2f}".format(latest_stock_price) }}/share</small>
            </div>
        </div>

        <div class="stat-card success">
            <div class="stat-icon">üíµ</div>
            <div class="stat-content">
                <div class="stat-label">Current Value</div>
                <div class="stat-value data-vested">${{ "{:,.2f}".format(total_current_value_vested) }}</div>
                <div class="stat-value data-all" style="display: none;">${{ "{:,.2f}".format(total_current_value_all) }}</div>
                <small class="data-vested">Cost basis: ${{ "{:,.2f}".format(total_cost_basis_vested) }}</small>
                <small class="data-all" style="display: none;">Cost basis: ${{ "{:,.2f}".format(total_cost_basis_all) }}</small>
            </div>
        </div>

        <div class="stat-card accent">
            <div class="stat-icon">üìà</div>
            <div class="stat-content">
                <div class="stat-label">Unrealized Gain</div>
                <div class="stat-value data-vested {% if total_unrealized_gain_vested >= 0 %}positive{% else %}negative{% endif %}">
                    ${{ "{:,.2f}".format(total_unrealized_gain_vested) }}
                </div>
                <div class="stat-value data-all {% if total_unrealized_gain_all >= 0 %}positive{% else %}negative{% endif %}" style="display: none;">
                    ${{ "{:,.2f}".format(total_unrealized_gain_all) }}
                </div>
                <small class="data-vested">{{ "{:.1f}".format((total_unrealized_gain_vested / total_cost_basis_vested * 100) if total_cost_basis_vested > 0 else 0) }}% return</small>
                <small class="data-all" style="display: none;">{{ "{:.1f}".format((total_unrealized_gain_all / total_cost_basis_all * 100) if total_cost_basis_all > 0 else 0) }}% return</small>
            </div>
        </div>

        <div class="stat-card warning">
            <div class="stat-icon">üßæ</div>
            <div class="stat-content">
                <div class="stat-label">Est. Tax on Sale</div>
                <div class="stat-value" id="totalTaxLiability">${{ "{:,.2f}".format(total_estimated_tax) }}</div>
                <small id="netAfterTax">Net: ${{ "{:,.2f}".format(total_current_value_all - total_estimated_tax) }}</small>
            </div>
        </div>
    </div>

    <!-- Column Customizer -->
    <div class="column-customizer-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;">üéõÔ∏è Customize Table Columns</h2>
            <button id="toggleCustomizer" class="btn btn-secondary">
                <span id="customizerToggleIcon">‚ñº</span> Show/Hide
            </button>
        </div>
        
        <div id="columnCustomizer" style="display: none;">
            <p class="text-muted" style="margin-bottom: 1rem;">Select and reorder the columns you want to see in the vest events tables below:</p>
            
            <div class="column-selector-grid">
                <div class="column-selector-item" data-column="vest-date" data-required="true">
                    <input type="checkbox" id="col-vest-date" checked disabled>
                    <label for="col-vest-date">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        Vest Date <span class="required-badge">Required</span>
                    </label>
                </div>
                
                <div class="column-selector-item" data-column="status" data-required="true">
                    <input type="checkbox" id="col-status" checked disabled>
                    <label for="col-status">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        Status <span class="required-badge">Required</span>
                    </label>
                </div>
                
                <div class="column-selector-item" data-column="shares-held">
                    <input type="checkbox" id="col-shares-held" checked>
                    <label for="col-shares-held">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        Shares Held
                    </label>
                </div>
                
                <div class="column-selector-item" data-column="cost-at-vest">
                    <input type="checkbox" id="col-cost-at-vest" checked>
                    <label for="col-cost-at-vest">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        Cost at Vest
                    </label>
                </div>
                
                <div class="column-selector-item" data-column="tax-paid">
                    <input type="checkbox" id="col-tax-paid" checked>
                    <label for="col-tax-paid">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        Tax Paid at Vest
                    </label>
                </div>
                
                <div class="column-selector-item" data-column="current-value">
                    <input type="checkbox" id="col-current-value" checked>
                    <label for="col-current-value">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        Current Total Value
                    </label>
                </div>
                
                <div class="column-selector-item" data-column="holding-period">
                    <input type="checkbox" id="col-holding-period" checked>
                    <label for="col-holding-period">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        Holding Period
                    </label>
                </div>
                
                <div class="column-selector-item" data-column="unrealized-gain">
                    <input type="checkbox" id="col-unrealized-gain" checked>
                    <label for="col-unrealized-gain">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        Unrealized Gain
                    </label>
                </div>
                
                <div class="column-selector-item" data-column="est-tax">
                    <input type="checkbox" id="col-est-tax" checked>
                    <label for="col-est-tax">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        Est. Tax on Sale
                    </label>
                </div>
            </div>
            
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button id="resetColumns" class="btn btn-secondary">Reset to Default</button>
                <button id="applyColumns" class="btn btn-primary">Apply Changes</button>
            </div>
        </div>
    </div>

    <!-- Detailed Analysis by Grant -->
    <div class="analysis-section">
        <h2>üìä Detailed Analysis by Grant</h2>
        
        {% for item in analysis_data %}
        <div class="grant-analysis-card" 
             data-shares-held-vested="{{ item.shares_held_vested }}"
             data-shares-held-all="{{ item.shares_held_all }}"
             data-cost-basis-vested="{{ item.cost_basis_vested }}"
             data-cost-basis-all="{{ item.cost_basis_all }}"
             data-current-value-vested="{{ item.current_value_vested }}"
             data-current-value-all="{{ item.current_value_all }}"
             data-unrealized-gain-vested="{{ item.unrealized_gain_vested }}"
             data-unrealized-gain-all="{{ item.unrealized_gain_all }}"
             data-grant-type="{{ item.grant.grant_type }}">
            
            <div class="grant-analysis-header">
                <h3>
                    <a href="{{ url_for('grants.view_grant', grant_id=item.grant.id) }}" style="text-decoration: none; color: inherit; display: inline-flex; align-items: center; gap: 0.5rem;">
                        {{ item.grant.grant_type|replace('_', ' ')|title }}
                        <span class="badge">{{ item.grant.share_type|upper }}</span>
                        <span style="font-size: 0.8em; opacity: 0.7;">üîó</span>
                    </a>
                </h3>
                <div class="grant-meta">
                    Granted: {{ item.grant.grant_date.strftime('%b %d, %Y') }} | 
                    {{ "{:,.0f}".format(item.grant.share_quantity) }} shares @ 
                    ${{ "{:,.2f}".format(item.grant.share_price_at_grant) }}
                </div>
            </div>

            <!-- Collapsible Grant Details -->
            <details open>
                <summary style="cursor: pointer; font-weight: 600; margin: 1rem 0; padding: 0.5rem; background: var(--background); border-radius: 6px;">
                    Grant Details & Vest Events
                    <span style="float: right; color: var(--text-secondary);">‚ñº</span>
                </summary>

            <div class="grant-summary-stats">
                <div class="summary-stat">
                    <div class="summary-label">Shares Held</div>
                    <div class="summary-value data-vested">{{ "{:,.0f}".format(item.shares_held_vested) }}</div>
                    <div class="summary-value data-all" style="display: none;">{{ "{:,.0f}".format(item.shares_held_all) }}</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-label">Cost Basis</div>
                    <div class="summary-value data-vested">${{ "{:,.2f}".format(item.cost_basis_vested) }}</div>
                    <div class="summary-value data-all" style="display: none;">${{ "{:,.2f}".format(item.cost_basis_all) }}</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-label">Current Value</div>
                    <div class="summary-value data-vested">${{ "{:,.2f}".format(item.current_value_vested) }}</div>
                    <div class="summary-value data-all" style="display: none;">${{ "{:,.2f}".format(item.current_value_all) }}</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-label">Unrealized Gain</div>
                    <div class="summary-value data-vested {{ 'positive' if item.unrealized_gain_vested > 0 else 'negative' }}">
                        ${{ "{:,.2f}".format(item.unrealized_gain_vested) }}
                    </div>
                    <div class="summary-value data-all {{ 'positive' if item.unrealized_gain_all > 0 else 'negative' }}" style="display: none;">
                        ${{ "{:,.2f}".format(item.unrealized_gain_all) }}
                    </div>
                </div>
                <div class="summary-stat">
                    <div class="summary-label">Est. Tax on Sale</div>
                    <div class="summary-value grant-tax-estimate">${{ "{:,.2f}".format(item.estimated_tax) }}</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-label">Net After Tax</div>
                    <div class="summary-value grant-net-value">${{ "{:,.2f}".format(item.current_value_all - item.estimated_tax) }}</div>
                </div>
            </div>

            <!-- Vest Events Table -->
            <details open>
                <summary style="cursor: pointer; font-weight: 600; margin: 1rem 0;">Vest Events ({{ item.vest_events|length }})</summary>
                <table class="vest-events-table">
                    <thead>
                        <tr class="table-header-row">
                            <th data-column="vest-date">Vest Date</th>
                            <th data-column="status">Status</th>
                            <th data-column="shares-held">Shares Held</th>
                            <th data-column="cost-at-vest">Cost at Vest</th>
                            <th data-column="tax-paid">Tax Paid at Vest</th>
                            <th data-column="current-value">Current Total Value</th>
                            <th data-column="holding-period">Holding Period</th>
                            <th data-column="unrealized-gain">Unrealized Gain</th>
                            <th data-column="est-tax">Est. Tax on Sale</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ve_data in item.vest_events %}
                        {% set ve = ve_data.vest_event %}
                        <tr class="vest-event-row {% if not ve_data.has_vested %}data-unvested{% endif %}"
                            data-shares-held="{{ ve_data.shares_held }}"
                            data-unrealized-gain="{{ ve_data.unrealized_gain }}"
                            data-is-long-term="{{ 'true' if ve_data.is_long_term else 'false' }}"
                            data-has-vested="{{ 'true' if ve_data.has_vested else 'false' }}"
                            data-tax-is-estimated="{{ 'true' if ve_data.tax_is_estimated else 'false' }}"
                            data-shares-vested="{{ ve.shares_vested }}"
                            data-current-price="{{ latest_stock_price }}">
                            <td data-column="vest-date">{{ ve.vest_date.strftime('%b %d, %Y') }}</td>
                            <td data-column="status">
                                {% if ve_data.has_vested %}
                                    <span class="badge {{ 'success' if ve_data.is_long_term else 'warning' }}">
                                        {{ 'LT' if ve_data.is_long_term else 'ST' }}
                                    </span>
                                {% else %}
                                    <span class="badge">Future</span>
                                {% endif %}
                            </td>
                            <td data-column="shares-held">{{ ve_data.shares_held }}</td>
                            <td data-column="cost-at-vest">${{ "{:,.2f}".format(ve_data.cost_basis) }}</td>
                            <td data-column="tax-paid" class="event-tax-paid">
                                {% if ve_data.tax_is_estimated %}
                                    <span class="estimated-tax" style="color: var(--warning-color);" title="Estimated tax - updates with tax sliders">
                                        ${{ "{:,.2f}".format(ve_data.tax_amount) }}*
                                    </span>
                                {% elif ve_data.has_vested %}
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        ${{ "{:,.2f}".format(ve_data.tax_amount) }}
                                        {% if ve_data.tax_breakdown and ve_data.tax_breakdown.has_breakdown %}
                                        <button class="btn-icon" onclick="toggleTaxBreakdown(this)" title="View tax breakdown" style="font-size: 0.8em; padding: 0.2rem 0.4rem;">üìä</button>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span style="color: var(--text-secondary);">‚Äî</span>
                                {% endif %}
                            </td>
                            <td data-column="current-value"><strong>${{ "{:,.2f}".format(ve_data.current_value) }}</strong></td>
                            <td data-column="holding-period">{{ ve_data.holding_period or '' }}</td>
                            <td data-column="unrealized-gain">${{ "{:,.2f}".format(ve_data.unrealized_gain) }}</td>
                            <td data-column="est-tax">${{ "{:,.2f}".format(ve_data.estimated_tax or 0) }}</td>
                        </tr>
                        
                        <!-- Tax Breakdown Row (Hidden by default) -->
                        {% if ve_data.has_vested and ve_data.tax_breakdown and ve_data.tax_breakdown.has_breakdown %}
                        <tr class="tax-breakdown-row" style="display: none;">
                            <td colspan="9" style="background: #f5f5f5; padding: 1.5rem; border-left: 4px solid var(--primary-color);">
                                <div style="max-width: 800px;">
                                    <h4 style="margin-top: 0; color: #1976d2; display: flex; align-items: center; gap: 0.5rem;">
                                        üí∞ Detailed Tax Breakdown for {{ ve.vest_date.strftime('%b %d, %Y') }}
                                        <span style="font-size: 0.75em; font-weight: normal; color: #333;">({{ ve_data.tax_breakdown.tax_year }} Tax Rates)</span>
                                    </h4>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                        <div class="tax-breakdown-item">
                                            <div style="font-size: 0.85em; color: #333; margin-bottom: 0.25rem; font-weight: 500;">Gross Value</div>
                                            <div style="font-size: 1.2em; font-weight: bold; color: #000;">${{ "{:,.2f}".format(ve_data.tax_breakdown.gross_value) }}</div>
                                        </div>
                                        
                                        <div class="tax-breakdown-item">
                                            <div style="font-size: 0.85em; color: #333; margin-bottom: 0.25rem; font-weight: 500;">Federal Income Tax</div>
                                            <div style="font-size: 1.1em; font-weight: 600; color: #c62828;">
                                                ${{ "{:,.2f}".format(ve_data.tax_breakdown.federal_tax) }}
                                                <span style="font-size: 0.8em; color: #555;">({{ "%.1f"|format(ve_data.tax_breakdown.federal_rate * 100) }}%)</span>
                                            </div>
                                        </div>
                                        
                                        <div class="tax-breakdown-item">
                                            <div style="font-size: 0.85em; color: #333; margin-bottom: 0.25rem; font-weight: 500;">State Income Tax</div>
                                            <div style="font-size: 1.1em; font-weight: 600; color: #c62828;">
                                                ${{ "{:,.2f}".format(ve_data.tax_breakdown.state_tax) }}
                                                <span style="font-size: 0.8em; color: #555;">({{ "%.1f"|format(ve_data.tax_breakdown.state_rate * 100) }}%)</span>
                                            </div>
                                        </div>
                                        
                                        <div class="tax-breakdown-item">
                                            <div style="font-size: 0.85em; color: #333; margin-bottom: 0.25rem; font-weight: 500;">Social Security</div>
                                            <div style="font-size: 1.1em; font-weight: 600; color: #0d47a1;">
                                                ${{ "{:,.2f}".format(ve_data.tax_breakdown.social_security_tax) }}
                                                <span style="font-size: 0.8em; color: #555;">({{ "%.2f"|format(ve_data.tax_breakdown.social_security_rate * 100) }}%)</span>
                                            </div>
                                        </div>
                                        
                                        <div class="tax-breakdown-item">
                                            <div style="font-size: 0.85em; color: #333; margin-bottom: 0.25rem; font-weight: 500;">Medicare</div>
                                            <div style="font-size: 1.1em; font-weight: 600; color: #0d47a1;">
                                                ${{ "{:,.2f}".format(ve_data.tax_breakdown.medicare_tax) }}
                                                <span style="font-size: 0.8em; color: #555;">({{ "%.2f"|format(ve_data.tax_breakdown.medicare_rate * 100) }}%)</span>
                                            </div>
                                        </div>
                                        
                                        {% if ve_data.tax_breakdown.additional_medicare_tax > 0 %}
                                        <div class="tax-breakdown-item">
                                            <div style="font-size: 0.85em; color: #333; margin-bottom: 0.25rem; font-weight: 500;">Additional Medicare</div>
                                            <div style="font-size: 1.1em; font-weight: 600; color: #0d47a1;">
                                                ${{ "{:,.2f}".format(ve_data.tax_breakdown.additional_medicare_tax) }}
                                                <span style="font-size: 0.8em; color: #555;">({{ "%.2f"|format(ve_data.tax_breakdown.additional_medicare_rate * 100) }}%)</span>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid #ccc;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                            <div>
                                                <div style="font-size: 0.85em; color: #333; font-weight: 500;">Total FICA (SS + Medicare)</div>
                                                <div style="font-size: 1.2em; font-weight: bold; color: #0d47a1;">
                                                    ${{ "{:,.2f}".format(ve_data.tax_breakdown.total_fica) }}
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <div style="font-size: 0.85em; color: #333; font-weight: 500;">Total Tax Withheld</div>
                                                <div style="font-size: 1.3em; font-weight: bold; color: #c62828;">
                                                    ${{ "{:,.2f}".format(ve_data.tax_breakdown.total_tax) }}
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <div style="font-size: 0.85em; color: #333; font-weight: 500;">Net Amount Received</div>
                                                <div style="font-size: 1.3em; font-weight: bold; color: #1b5e20;">
                                                    ${{ "{:,.2f}".format(ve_data.tax_breakdown.net_amount) }}
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <div style="font-size: 0.85em; color: #333; font-weight: 500;">Effective Tax Rate</div>
                                                <div style="font-size: 1.2em; font-weight: bold; color: #000;">
                                                    {{ "%.1f"|format(ve_data.tax_breakdown.effective_rate * 100) }}%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 1rem; padding: 0.75rem; background: #fff; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; color: #333;">
                                        <strong style="color: #000;">üìù Note:</strong> This breakdown shows actual paycheck taxes including FICA (Social Security 6.2% up to $168,600 wage base + Medicare 1.45%). 
                                        Additional Medicare (0.9%) applies to income over $200k (single) or $250k (married).
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        
                        {% endfor %}
                    </tbody>
                </table>
            </details>
            
            </details>
            <!-- End of Grant Details Collapsible -->
        </div>
        {% endfor %}
    </div>

    <!-- Tax Information -->
    <div class="info-section">
        <div style="background: var(--warning-bg, #fff3cd); border-left: 4px solid var(--warning-color, #ff9800); padding: 1rem; margin-bottom: 2rem; border-radius: 4px;">
            <strong>üìä Tax Estimate Note:</strong> Values marked with an asterisk (*) are <em>estimated</em> taxes for future vesting events. 
            These estimates update dynamically as you adjust the tax rate sliders above, using your selected federal and state rates plus FICA (7.65%). 
            Actual withholding may vary based on your total income and tax situation.
        </div>
        
        <h2>üìö Tax Basics</h2>
        <div class="tax-info-grid">
            <div class="tax-info-card">
                <h3>Ordinary Income (Vest Date)</h3>
                <p><strong>When:</strong> At vest date</p>
                <p><strong>Taxed as:</strong> Ordinary income (W-2)</p>
                <p><strong>Rate:</strong> Your marginal tax rate (22%-37%+)</p>
                <p><strong>How:</strong> Shares withheld or cash-to-cover</p>
            </div>

            <div class="tax-info-card">
                <h3>Short-Term Capital Gains</h3>
                <p><strong>When:</strong> Sold within 1 year of vesting</p>
                <p><strong>Taxed as:</strong> Ordinary income</p>
                <p><strong>Rate:</strong> Your marginal tax rate (22%-37%+)</p>
                <p><strong>Basis:</strong> Value at vest date</p>
            </div>

            <div class="tax-info-card">
                <h3>Long-Term Capital Gains</h3>
                <p><strong>When:</strong> Sold after 1+ year of vesting</p>
                <p><strong>Taxed as:</strong> Long-term capital gains</p>
                <p><strong>Rate:</strong> Preferential (0%, 15%, or 20%)</p>
                <p><strong>Basis:</strong> Value at vest date</p>
            </div>

            <div class="tax-info-card">
                <h3>ISO Special Rules</h3>
                <p><strong>AMT:</strong> Alternative Minimum Tax may apply</p>
                <p><strong>Qualifying:</strong> Hold 2 years from grant + 1 year from exercise</p>
                <p><strong>Spread:</strong> Exercise price vs FMV triggers AMT</p>
                <p><strong>Benefit:</strong> Potential long-term capital gains on entire gain</p>
            </div>
        </div>
    </div>

    <!-- Tax Planning Section -->
    <div class="tax-planning-section">
        <h2>üí° Tax Planning Insights</h2>
        <div class="insights-grid">
            <div class="insight-card">
                <h3>üéØ Optimize Holdings</h3>
                <p>Consider holding shares for 1+ year after vesting to qualify for long-term capital gains rates (0-20%) instead of ordinary income rates (22-37%).</p>
            </div>

            <div class="insight-card">
                <h3>üìÖ Tax-Loss Harvesting</h3>
                <p>If you have shares with unrealized losses, consider selling them to offset capital gains elsewhere in your portfolio.</p>
            </div>

            <div class="insight-card">
                <h3>üîÑ Diversification</h3>
                <p>While your stock may appreciate, consider diversifying to manage concentration risk. Selling some shares (even at higher tax rates) may be prudent.</p>
            </div>

            <div class="insight-card">
                <h3>‚öñÔ∏è ISO AMT Planning</h3>
                <p>For ISOs, the spread at exercise may trigger Alternative Minimum Tax (AMT). Plan exercises strategically to minimize AMT impact.</p>
            </div>
        </div>
    </div>

    <!-- Disclaimer -->
    <div class="disclaimer">
        <p><strong>‚ö†Ô∏è Disclaimer:</strong> This information is for educational purposes only and should not be considered tax or financial advice. Tax laws are complex and change frequently. Consult with a qualified tax professional or financial advisor for personalized guidance based on your specific situation.</p>
    </div>
</div>

<style>
.finance-deep-dive {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.subtitle {
    color: var(--text-secondary);
    font-size: 1.1rem;
    margin-top: 0.5rem;
}

/* Tax Configuration Section */
.tax-config-section {
    background: var(--surface);
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
    border: 2px solid var(--accent);
}

.tax-config-section h2 {
    margin-top: 0;
}

/* Column Customizer Section */
.column-customizer-section {
    background: var(--surface);
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
    border: 2px solid var(--border);
}

.column-customizer-section h2 {
    margin-top: 0;
}

.column-selector-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 0.75rem;
    margin: 1rem 0;
}

.column-selector-item {
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem;
    cursor: move;
    transition: all 0.2s;
}

.column-selector-item:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.column-selector-item[data-required="true"] {
    opacity: 0.7;
    cursor: not-allowed;
}

.column-selector-item label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    margin: 0;
}

.column-selector-item[data-required="true"] label {
    cursor: not-allowed;
}

.column-selector-item input[type="checkbox"] {
    cursor: pointer;
}

.column-selector-item input[type="checkbox"]:disabled {
    cursor: not-allowed;
}

.drag-handle {
    color: var(--text-secondary);
    font-size: 1.2rem;
    cursor: move;
}

.required-badge {
    font-size: 0.7rem;
    background: var(--accent);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    margin-left: auto;
}

.text-muted {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
}

.tax-sliders {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.tax-slider-item {
    display: flex;
    flex-direction: column;
}

.tax-slider-item label {
    font-size: 1rem;
    margin-bottom: 0.5rem;
    color: var(--text);
}

.tax-slider {
    width: 100%;
    height: 8px;
    border-radius: 5px;
    background: var(--border);
    outline: none;
    -webkit-appearance: none;
}

.tax-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
}

.tax-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: none;
}

.slider-help {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

/* Summary Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}

.stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-card.success {
    border-color: var(--success);
}

.stat-card.accent {
    border-color: var(--accent);
}

.stat-card.warning {
    border-color: #f59e0b;
}

.stat-icon {
    font-size: 2.5rem;
}

.stat-content {
    flex: 1;
}

.stat-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--text);
}

.stat-value.positive {
    color: var(--success);
}

.stat-value.negative {
    color: var(--error);
}

.stat-content small {
    font-size: 0.75rem;
    color: var(--text-secondary);
    display: block;
    margin-top: 0.25rem;
}

/* Analysis Section */
.info-section {
    background: var(--surface);
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
}

.tax-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.tax-info-card {
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
}

.tax-info-card h3 {
    color: var(--accent);
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.1rem;
}

.tax-info-card p {
    margin: 0.5rem 0;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.tax-info-card strong {
    color: var(--text);
}

.analysis-section {
    margin: 2rem 0;
}

.grant-analysis-card {
    background: var(--surface);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid var(--border);
}

.grant-analysis-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.grant-analysis-header h3 a {
    transition: opacity 0.2s;
}

.grant-analysis-header h3 a:hover {
    opacity: 0.8;
    text-decoration: underline !important;
}

.grant-meta {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-top: 0.5rem;
}

/* Grant Details Collapsible */
.grant-analysis-card details > summary {
    list-style: none;
    transition: background 0.2s;
}

.grant-analysis-card details > summary::-webkit-details-marker {
    display: none;
}

.grant-analysis-card details > summary:hover {
    background: var(--border);
}

.grant-analysis-card details[open] > summary span {
    transform: rotate(180deg);
    display: inline-block;
    transition: transform 0.2s;
}

.grant-summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1.5rem;
    margin: 1.5rem 0;
    padding: 1.5rem;
    background: var(--background);
    border-radius: 8px;
}

.summary-stat {
    text-align: center;
}

.summary-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.summary-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text);
}

.summary-value.positive {
    color: var(--success);
}

.summary-value.negative {
    color: var(--error);
}

.vest-events-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    font-size: 0.9rem;
}

.vest-events-table th,
.vest-events-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

.vest-events-table th {
    background: var(--background);
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.85rem;
    text-transform: uppercase;
}

.vest-events-table td.positive {
    color: var(--success);
}

.vest-events-table td.negative {
    color: var(--error);
}

.badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    background: var(--accent);
    color: var(--background);
}

.badge.success {
    background: var(--success);
}

.badge.warning {
    background: #f59e0b;
}

.tax-planning-section {
    background: var(--surface);
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
}

.insights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.insight-card {
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
}

.insight-card h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.1rem;
}

.insight-card p {
    color: var(--text-secondary);
    line-height: 1.6;
    margin: 0;
}

.disclaimer {
    background: rgba(251, 191, 36, 0.1);
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 2rem 0;
}

.disclaimer p {
    margin: 0;
    color: var(--text);
    line-height: 1.6;
}

/* Toggle Switch */
.toggle-container {
    display: flex;
    align-items: center;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--border);
    transition: .4s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    border-radius: 50%;
    background: white;
    left: 3px;
    bottom: 3px;
    transition: .4s;
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(26px);
}

/* Unvested rows styling */
.data-unvested {
    opacity: 0.6;
    background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 10px,
        rgba(0,0,0,0.03) 10px,
        rgba(0,0,0,0.03) 20px
    );
}

</style>

<script>
// Server-side total estimated tax exposed to client JS (JSON-safe)
const serverTotalEstimatedTax = {{ total_estimated_tax | default(0) | tojson }};
</script>

<!-- Tax calculation scripts continue below (DOMContentLoaded handler) -->
<script>
// Toggle tax breakdown visibility
function toggleTaxBreakdown(button) {
    const row = button.closest('tr');
    const breakdownRow = row.nextElementSibling;
    
    if (breakdownRow && breakdownRow.classList.contains('tax-breakdown-row')) {
        if (breakdownRow.style.display === 'none') {
            breakdownRow.style.display = 'table-row';
            button.textContent = 'üìä';
            button.title = 'Hide tax breakdown';
        } else {
            breakdownRow.style.display = 'none';
            button.textContent = 'üìä';
            button.title = 'View tax breakdown';
        }
    }
}

// Wait for DOM to be fully loaded before running scripts
document.addEventListener('DOMContentLoaded', function() {

// Tax calculation logic
const federalSlider = document.getElementById('federalTaxRate');
const stateSlider = document.getElementById('stateTaxRate');
const capitalGainsSlider = document.getElementById('capitalGainsTaxRate');
const showAllToggle = document.getElementById('showAllToggle');
const toggleLabel = document.getElementById('toggleLabel');

const federalValue = document.getElementById('federalTaxValue');
const stateValue = document.getElementById('stateTaxValue');
const capitalGainsValue = document.getElementById('capitalGainsValue');
const ficaValue = document.getElementById('ficaValue');

// Toggle between vested and all shares
showAllToggle.addEventListener('change', (e) => {
    const showAll = e.target.checked;
    toggleLabel.textContent = showAll ? 'All Shares (Including Future)' : 'Vested Only';
    document.querySelectorAll('.data-unvested').forEach(el => {
        if (showAll) {
            el.style.display = 'flex';  // Use flex to maintain column layout
        } else {
            el.style.display = 'none';
        }
    });
    
    // Recalculate taxes
    calculateTaxes();
});

// Update slider display values
federalSlider.addEventListener('input', (e) => {
    federalValue.textContent = e.target.value;
    calculateTaxes();
});

stateSlider.addEventListener('input', (e) => {
    stateValue.textContent = e.target.value;
    calculateTaxes();
});

capitalGainsSlider.addEventListener('input', (e) => {
    capitalGainsValue.textContent = e.target.value;
    calculateTaxes();
});

ficaSlider.addEventListener('input', (e) => {
    ficaValue.textContent = parseFloat(e.target.value).toFixed(2);
    calculateTaxes();
});

function calculateTaxes() {
    const federalRate = parseFloat(federalSlider.value) / 100;
    const stateRate = parseFloat(stateSlider.value) / 100;
    const capitalGainsRate = parseFloat(capitalGainsSlider.value) / 100;
    const showAll = showAllToggle.checked;
    const ficaRate = parseFloat(ficaSlider.value) / 100;

    let totalTax = 0;
    let totalCurrentValue = 0;

    console.debug('calculateTaxes invoked', { federalRate, stateRate, capitalGainsRate, ficaRate, showAll });

    document.querySelectorAll('.grant-analysis-card').forEach(card => {
        const sharesHeldVested = parseFloat(card.dataset.sharesHeldVested) || 0;
        const sharesHeldAll = parseFloat(card.dataset.sharesHeldAll) || 0;
        const costBasisVested = parseFloat(card.dataset.costBasisVested) || 0;
        const costBasisAll = parseFloat(card.dataset.costBasisAll) || 0;
        const currentValueVested = parseFloat(card.dataset.currentValueVested) || 0;
        const currentValueAll = parseFloat(card.dataset.currentValueAll) || 0;
        const unrealizedGainVested = parseFloat(card.dataset.unrealizedGainVested) || 0;
        const unrealizedGainAll = parseFloat(card.dataset.unrealizedGainAll) || 0;

        // Use vested or all depending on toggle
        const currentValue = showAll ? currentValueAll : currentValueVested;
        const unrealizedGain = showAll ? unrealizedGainAll : unrealizedGainVested;

        let grantTax = 0;

        // Iterate vest events
        card.querySelectorAll('.vest-event-row').forEach(row => {
            const hasVested = row.dataset.hasVested === 'true';
            if (!showAll && !hasVested) return; // skip if filtering

            const eventUnrealizedGain = parseFloat(row.dataset.unrealizedGain) || 0;
            const sharesHeld = parseFloat(row.dataset.sharesHeld) || 0;
            const isLongTerm = row.dataset.isLongTerm === 'true';
            const taxIsEstimated = row.dataset.taxIsEstimated === 'true';

            console.debug('event', { eventUnrealizedGain, sharesHeld, isLongTerm, taxIsEstimated });

            // Update estimated 'Tax Paid at Vest' for future/estimated rows (if present)
            if (taxIsEstimated && !hasVested) {
                const sharesVested = parseFloat(row.dataset.sharesVested) || 0;
                const currentPrice = parseFloat(row.dataset.currentPrice) || 0;

                // Determine vestValue per grant/row
                let vestValue = sharesVested * currentPrice;
                // Update withholding cell if present
                const taxPaidSpan = row.querySelector('.event-tax-paid .estimated-tax');
                if (taxPaidSpan) {
                    const estimatedVestTax = vestValue * (federalRate + stateRate + ficaRate);
                    taxPaidSpan.textContent = '$' + estimatedVestTax.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '*';
                }
            }

            // Calculate tax on unrealized gain (if positive)
            let eventTax = 0;
            if (eventUnrealizedGain > 0) {
                if (isLongTerm) {
                    eventTax = eventUnrealizedGain * (capitalGainsRate + stateRate);
                } else {
                    eventTax = eventUnrealizedGain * (federalRate + stateRate);
                }
            }

            console.debug('eventTax computed', { eventTax });

            // Update the event-level Est. Tax cell (data-column="est-tax")
            const estTaxCell = row.querySelector('td[data-column="est-tax"]');
            if (estTaxCell) {
                estTaxCell.textContent = '$' + eventTax.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }

            grantTax += (eventTax > 0 ? eventTax : 0);
        });

        // Update grant-level displays
        const taxEstimateEl = card.querySelector('.grant-tax-estimate');
        const netValueEl = card.querySelector('.grant-net-value');
        if (taxEstimateEl && netValueEl) {
            // Preserve server-rendered value if client-side grantTax is zero or NaN
            const existingTaxText = taxEstimateEl.textContent.trim();
            if (grantTax > 0) {
                taxEstimateEl.textContent = '$' + grantTax.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            } else if (existingTaxText && existingTaxText !== '$0.00') {
                // leave the server-rendered value as-is
            } else {
                taxEstimateEl.textContent = '$0.00';
            }

            // For net value, prefer client calc if meaningful, otherwise keep server-rendered
            const existingNetText = netValueEl.textContent.trim();
            const computedNet = currentValue - grantTax;
            if (!isNaN(computedNet) && (grantTax > 0 || existingNetText === '' || existingNetText === '$0.00')) {
                netValueEl.textContent = '$' + computedNet.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }

            if ((currentValue - grantTax) >= 0) {
                netValueEl.classList.add('positive');
                netValueEl.classList.remove('negative');
            } else {
                netValueEl.classList.add('negative');
                netValueEl.classList.remove('positive');
            }
        }

        totalTax += grantTax;
        totalCurrentValue += currentValue;
    });

    // Prefer server-side total if client-side calculation yields zero or NaN
    const clientTotalTax = totalTax;
    const finalTotalTax = (clientTotalTax && clientTotalTax > 0) ? clientTotalTax : (typeof serverTotalEstimatedTax !== 'undefined' ? serverTotalEstimatedTax : 0);
    const netAfterTax = totalCurrentValue - finalTotalTax;
    const totalTaxEl = document.getElementById('totalTaxLiability');
    const netAfterTaxEl = document.getElementById('netAfterTax');
    if (totalTaxEl) totalTaxEl.textContent = '$' + finalTotalTax.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    if (netAfterTaxEl) netAfterTaxEl.textContent = 'Net: $' + netAfterTax.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

// Calculate on page load
calculateTaxes();

// Hide unvested rows initially
document.querySelectorAll('.data-unvested').forEach(el => {
    el.style.display = 'none';
});

// ==================== Column Customizer ====================

const columnCustomizer = document.getElementById('columnCustomizer');
const toggleCustomizer = document.getElementById('toggleCustomizer');
const customizerToggleIcon = document.getElementById('customizerToggleIcon');
const applyColumnsBtn = document.getElementById('applyColumns');
const resetColumnsBtn = document.getElementById('resetColumns');

// Toggle customizer visibility
toggleCustomizer.addEventListener('click', () => {
    const isHidden = columnCustomizer.style.display === 'none';
    columnCustomizer.style.display = isHidden ? 'block' : 'none';
    customizerToggleIcon.textContent = isHidden ? '‚ñ≤' : '‚ñº';
});

// Default column order
const defaultColumns = [
    'vest-date', 'status', 'shares-held', 'cost-at-vest', 
    'tax-paid', 'current-value', 'holding-period', 
    'unrealized-gain', 'est-tax'
];

// Load saved preferences from localStorage
function loadColumnPreferences() {
    const saved = localStorage.getItem('financeTableColumns');
    if (saved) {
        return JSON.parse(saved);
    }
    return {
        order: [...defaultColumns],
        visible: defaultColumns.reduce((acc, col) => ({ ...acc, [col]: true }), {})
    };
}

// Save preferences to localStorage
function saveColumnPreferences(prefs) {
    localStorage.setItem('financeTableColumns', JSON.stringify(prefs));
}

// Apply column visibility and order to all tables
function applyColumnSettings() {
    const prefs = loadColumnPreferences();
    
    // Update checkboxes
    document.querySelectorAll('.column-selector-item').forEach(item => {
        const column = item.dataset.column;
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox && !checkbox.disabled) {
            checkbox.checked = prefs.visible[column] !== false;
        }
    });
    
    // Apply to all tables
    document.querySelectorAll('.vest-events-table').forEach(table => {
        const headerRow = table.querySelector('.table-header-row');
        const headers = Array.from(headerRow.querySelectorAll('th'));
        const bodyRows = Array.from(table.querySelectorAll('tbody tr'));
        
        // Hide/show columns based on preferences
        prefs.order.forEach((column, index) => {
            const visible = prefs.visible[column] !== false;
            
            // Find header and cells for this column
            const header = headers.find(h => h.dataset.column === column);
            
            if (header) {
                header.style.display = visible ? '' : 'none';
                header.style.order = index;
            }
            
            // Update all body cells
            bodyRows.forEach(row => {
                const cell = Array.from(row.querySelectorAll('td')).find(c => c.dataset.column === column);
                if (cell) {
                    cell.style.display = visible ? '' : 'none';
                    cell.style.order = index;
                }
            });
        });
        
        // Use flexbox for reordering
        headerRow.style.display = 'flex';
        bodyRows.forEach(row => {
            // Check if row should be hidden (unvested rows when showing vested only)
            const isUnvested = row.classList.contains('data-unvested');
            const showAll = showAllToggle.checked;
            
            // Only set display to flex if row should be visible
            if (!isUnvested || showAll) {
                row.style.display = 'flex';
            }
            
            row.querySelectorAll('td').forEach(cell => {
                cell.style.flex = '1';
                cell.style.minWidth = '100px';
            });
        });
        headerRow.querySelectorAll('th').forEach(th => {
            th.style.flex = '1';
            th.style.minWidth = '100px';
        });
    });
}

// Apply button handler
applyColumnsBtn.addEventListener('click', () => {
    const prefs = {
        order: [],
        visible: {}
    };
    
    // Get current order and visibility from selector items
    document.querySelectorAll('.column-selector-item').forEach(item => {
        const column = item.dataset.column;
        const checkbox = item.querySelector('input[type="checkbox"]');
        
        prefs.order.push(column);
        prefs.visible[column] = checkbox.checked;
    });
    
    saveColumnPreferences(prefs);
    applyColumnSettings();
    
    // Show feedback
    const originalText = applyColumnsBtn.textContent;
    applyColumnsBtn.textContent = '‚úì Applied!';
    applyColumnsBtn.style.background = 'var(--success)';
    setTimeout(() => {
        applyColumnsBtn.textContent = originalText;
        applyColumnsBtn.style.background = '';
    }, 1500);
});

// Reset button handler
resetColumnsBtn.addEventListener('click', () => {
    const prefs = {
        order: [...defaultColumns],
        visible: defaultColumns.reduce((acc, col) => ({ ...acc, [col]: true }), {})
    };
    
    saveColumnPreferences(prefs);
    applyColumnSettings();
    
    // Show feedback
    const originalText = resetColumnsBtn.textContent;
    resetColumnsBtn.textContent = '‚úì Reset!';
    setTimeout(() => {
        resetColumnsBtn.textContent = originalText;
    }, 1500);
});

// Drag and drop for reordering
let draggedItem = null;

document.querySelectorAll('.column-selector-item').forEach(item => {
    item.draggable = true;
    
    item.addEventListener('dragstart', (e) => {
        draggedItem = item;
        item.style.opacity = '0.5';
    });
    
    item.addEventListener('dragend', (e) => {
        item.style.opacity = '';
        draggedItem = null;
    });
    
    item.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(item.parentElement, e.clientY);
        if (afterElement == null) {
            item.parentElement.appendChild(draggedItem);
        } else {
            item.parentElement.insertBefore(draggedItem, afterElement);
        }
    });
});

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.column-selector-item:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// Apply settings on page load
applyColumnSettings();

}); // End of DOMContentLoaded

</script>
{% endblock %}
