{% extends "base.html" %}

{% block title %}Transactions - VestX{% endblock %}

{% block content %}
<div class="container">
    <h1>ðŸ“Š Stock Transactions</h1>
    <p class="subtitle">Record and track your stock sales and ISO exercises for accurate tax reporting</p>
    
    <!-- Action Buttons -->
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
        <button class="btn btn-primary" onclick="openSaleModal()">+ Record Stock Sale</button>
        <button class="btn btn-primary" onclick="openExerciseModal()">+ Record ISO Exercise</button>
    </div>
    
    <!-- Stock Sales Section -->
    <div class="card" style="margin-bottom: 2rem;">
        <h2>Stock Sales</h2>
        {% if sales %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Shares</th>
                        <th>Sale Price</th>
                        <th>Proceeds</th>
                        <th>Cost Basis</th>
                        <th>Gain/Loss</th>
                        <th>Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr>
                        <td>{{ sale.sale_date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ sale.shares_sold|round(2) }}</td>
                        <td>${{ sale.sale_price|round(2) }}</td>
                        <td>${{ sale.total_proceeds|round(2) }}</td>
                        <td>${{ sale.total_cost_basis|round(2) }}</td>
                        <td style="color: {{ 'green' if sale.capital_gain > 0 else 'red' }}">
                            ${{ sale.capital_gain|round(2) }}
                        </td>
                        <td>
                            <span class="badge {{ 'badge-success' if sale.is_long_term else 'badge-warning' }}">
                                {{ 'Long-term' if sale.is_long_term else 'Short-term' }}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteSale({{ sale.id }})">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="empty-message">No stock sales recorded yet.</p>
        {% endif %}
    </div>
    
    <!-- ISO Exercises Section -->
    <div class="card">
        <h2>ISO Exercises</h2>
        {% if exercises %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Shares</th>
                        <th>Strike Price</th>
                        <th>FMV</th>
                        <th>Bargain Element</th>
                        <th>AMT Triggered</th>
                        <th>Still Held</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for exercise in exercises %}
                    <tr>
                        <td>{{ exercise.exercise_date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ exercise.shares_exercised|round(2) }}</td>
                        <td>${{ exercise.strike_price|round(2) }}</td>
                        <td>${{ exercise.fmv_at_exercise|round(2) }}</td>
                        <td>${{ exercise.total_bargain_element|round(2) }}</td>
                        <td>
                            <span class="badge {{ 'badge-danger' if exercise.amt_triggered else 'badge-success' }}">
                                {{ 'Yes' if exercise.amt_triggered else 'No' }}
                            </span>
                        </td>
                        <td>{{ exercise.shares_still_held|round(2) }}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteExercise({{ exercise.id }})">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="empty-message">No ISO exercises recorded yet.</p>
        {% endif %}
    </div>
</div>

<!-- Stock Sale Modal -->
<div id="saleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Record Stock Sale</h2>
            <span class="close" onclick="closeSaleModal()">&times;</span>
        </div>
        <form id="saleForm" onsubmit="submitSale(event)">
            <div class="form-group">
                <label for="sale_date">Sale Date *</label>
                <input type="date" id="sale_date" required>
            </div>
            
            <div class="form-group">
                <label for="vest_event_id">From Vest (Optional)</label>
                <select id="vest_event_id">
                    <option value="">-- Select Vest --</option>
                    {% for vest in vests %}
                    <option value="{{ vest.id }}">
                        {{ vest.vest_date.strftime('%Y-%m-%d') }} - {{ vest.shares_vested }} shares ({{ vest.grant.grant_type }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="shares_sold">Shares Sold *</label>
                    <input type="number" id="shares_sold" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="sale_price">Sale Price (per share) *</label>
                    <input type="number" id="sale_price" step="0.01" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="cost_basis_per_share">Cost Basis (per share) *</label>
                    <input type="number" id="cost_basis_per_share" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="commission_fees">Commission/Fees</label>
                    <input type="number" id="commission_fees" step="0.01" value="0">
                </div>
            </div>
            
            <div class="form-group">
                <label for="sale_notes">Notes</label>
                <textarea id="sale_notes" rows="2"></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeSaleModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Record Sale</button>
            </div>
        </form>
    </div>
</div>

<!-- ISO Exercise Modal -->
<div id="exerciseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Record ISO Exercise</h2>
            <span class="close" onclick="closeExerciseModal()">&times;</span>
        </div>
        <form id="exerciseForm" onsubmit="submitExercise(event)">
            <div class="form-group">
                <label for="exercise_date">Exercise Date *</label>
                <input type="date" id="exercise_date" required>
            </div>
            
            <div class="form-group">
                <label for="exercise_vest_event_id">From Vest (Optional)</label>
                <select id="exercise_vest_event_id">
                    <option value="">-- Select Vest --</option>
                    {% for vest in vests %}
                    {% if vest.grant.share_type in ['iso_5y', 'iso_6y'] %}
                    <option value="{{ vest.id }}">
                        {{ vest.vest_date.strftime('%Y-%m-%d') }} - {{ vest.shares_vested }} shares @ ${{ vest.grant.share_price_at_grant }}
                    </option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="shares_exercised">Shares Exercised *</label>
                    <input type="number" id="shares_exercised" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="strike_price">Strike Price *</label>
                    <input type="number" id="strike_price" step="0.01" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="fmv_at_exercise">FMV at Exercise *</label>
                    <input type="number" id="fmv_at_exercise" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="cash_paid">Cash Paid</label>
                    <input type="number" id="cash_paid" step="0.01">
                </div>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="amt_triggered">
                    AMT Triggered by this exercise
                </label>
            </div>
            
            <div class="form-row" id="amtFields" style="display: none;">
                <div class="form-group">
                    <label for="amt_paid">AMT Paid</label>
                    <input type="number" id="amt_paid" step="0.01">
                </div>
                <div class="form-group">
                    <label for="amt_credit_generated">AMT Credit Generated</label>
                    <input type="number" id="amt_credit_generated" step="0.01">
                </div>
            </div>
            
            <div class="form-group">
                <label for="exercise_notes">Notes</label>
                <textarea id="exercise_notes" rows="2"></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeExerciseModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Record Exercise</button>
            </div>
        </form>
    </div>
</div>

<style>
.empty-message {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 600;
}

.badge-success {
    background: rgba(39, 174, 96, 0.1);
    color: #27ae60;
}

.badge-warning {
    background: rgba(230, 126, 34, 0.1);
    color: #e67e22;
}

.badge-danger {
    background: rgba(231, 76, 60, 0.1);
    color: #e74c3c;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}
</style>

<script>
const CSRF_TOKEN = '{{ csrf_token() }}';

function openSaleModal() {
    document.getElementById('saleModal').style.display = 'block';
}

function closeSaleModal() {
    document.getElementById('saleModal').style.display = 'none';
    document.getElementById('saleForm').reset();
}

function openExerciseModal() {
    document.getElementById('exerciseModal').style.display = 'block';
}

function closeExerciseModal() {
    document.getElementById('exerciseModal').style.display = 'none';
    document.getElementById('exerciseForm').reset();
}

// Show AMT fields when checkbox is checked
document.getElementById('amt_triggered').addEventListener('change', function(e) {
    document.getElementById('amtFields').style.display = e.target.checked ? 'grid' : 'none';
});

async function submitSale(e) {
    e.preventDefault();
    
    const data = {
        sale_date: document.getElementById('sale_date').value,
        vest_event_id: document.getElementById('vest_event_id').value || null,
        shares_sold: document.getElementById('shares_sold').value,
        sale_price: document.getElementById('sale_price').value,
        cost_basis_per_share: document.getElementById('cost_basis_per_share').value,
        commission_fees: document.getElementById('commission_fees').value,
        notes: document.getElementById('sale_notes').value
    };
    
    try {
        const response = await fetch('/transactions/api/transactions/sales', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Stock sale recorded successfully!');
            location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        alert('Error recording sale: ' + error.message);
    }
}

async function submitExercise(e) {
    e.preventDefault();
    
    const data = {
        exercise_date: document.getElementById('exercise_date').value,
        vest_event_id: document.getElementById('exercise_vest_event_id').value || null,
        shares_exercised: document.getElementById('shares_exercised').value,
        strike_price: document.getElementById('strike_price').value,
        fmv_at_exercise: document.getElementById('fmv_at_exercise').value,
        cash_paid: document.getElementById('cash_paid').value || null,
        amt_triggered: document.getElementById('amt_triggered').checked,
        amt_paid: document.getElementById('amt_paid').value || null,
        amt_credit_generated: document.getElementById('amt_credit_generated').value || null,
        notes: document.getElementById('exercise_notes').value
    };
    
    try {
        const response = await fetch('/transactions/api/transactions/exercises', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('ISO exercise recorded successfully!');
            location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        alert('Error recording exercise: ' + error.message);
    }
}

async function deleteSale(id) {
    if (!confirm('Are you sure you want to delete this sale?')) return;
    
    try {
        const response = await fetch(`/transactions/api/transactions/sales/${id}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': CSRF_TOKEN
            }
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        alert('Error deleting sale: ' + error.message);
    }
}

async function deleteExercise(id) {
    if (!confirm('Are you sure you want to delete this exercise?')) return;
    
    try {
        const response = await fetch(`/transactions/api/transactions/exercises/${id}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': CSRF_TOKEN
            }
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        alert('Error deleting exercise: ' + error.message);
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}
</script>
{% endblock %}
